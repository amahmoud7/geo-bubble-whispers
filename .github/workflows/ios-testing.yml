name: iOS Testing Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  ios-tests:
    runs-on: macos-latest
    
    strategy:
      matrix:
        device: [iphone-se, iphone-15-pro, iphone-15-pro-max, ipad-air]
        test-category: [native, performance, accessibility, compatibility]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npm install -g @capacitor/cli
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: List available simulators
      run: xcrun simctl list devices
    
    - name: Setup iOS testing environment
      run: |
        node ios-testing/scripts/simulator-manager.js setup ${{ matrix.device }}
    
    - name: Build iOS app
      run: |
        npm run build
        npx cap add ios
        npx cap sync ios
    
    - name: Run iOS tests
      run: |
        npm run test:ios:${{ matrix.test-category }} -- --device=${{ matrix.device }}
      continue-on-error: true
    
    - name: Capture screenshots
      if: always()
      run: |
        mkdir -p ios-testing/reports/screenshots/${{ matrix.device }}
        node ios-testing/scripts/simulator-manager.js screenshot ${{ matrix.device }}
    
    - name: Generate test report
      if: always()
      run: |
        npm run test:ios:report
    
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-test-results-${{ matrix.device }}-${{ matrix.test-category }}
        path: |
          ios-testing/reports/
        retention-days: 30
    
    - name: Cleanup simulators
      if: always()
      run: |
        node ios-testing/scripts/simulator-manager.js cleanup

  ios-integration-tests:
    runs-on: macos-latest
    needs: ios-tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npm install -g @capacitor/cli
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run comprehensive integration tests
      run: |
        npm run test:ios -- --devices=all --categories=integration --parallel
    
    - name: Generate comprehensive report
      if: always()
      run: |
        npm run test:ios:report
    
    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-integration-test-results
        path: |
          ios-testing/reports/
        retention-days: 30

  publish-test-results:
    runs-on: ubuntu-latest
    needs: [ios-tests, ios-integration-tests]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: test-results/
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Consolidate test results
      run: |
        node ios-testing/scripts/consolidate-results.js test-results/
    
    - name: Generate final report
      run: |
        node ios-testing/scripts/generate-report.js
    
    - name: Publish test results to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ios-testing/reports/
        destination_dir: test-reports
    
    - name: Comment PR with test results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'ios-testing/reports/ios-test-summary-latest.json';
          
          if (fs.existsSync(path)) {
            const summary = JSON.parse(fs.readFileSync(path, 'utf8'));
            
            const comment = `
            ## ðŸ§ª iOS Test Results
            
            **Overall Status:** ${summary.summary.overallStatus.replace('_', ' ')}
            **Pass Rate:** ${summary.summary.passRate}%
            
            ### Summary
            - ðŸ“± **Devices Tested:** ${summary.summary.totalDevices}
            - ðŸ§ª **Total Tests:** ${summary.summary.totalTests}
            - âœ… **Passed:** ${summary.summary.passedTests}
            - âŒ **Failed:** ${summary.summary.failedTests}
            - âš ï¸ **Warnings:** ${summary.summary.warningTests}
            - â­ï¸ **Skipped:** ${summary.summary.skippedTests}
            
            ### Devices
            ${Object.entries(summary.devices).map(([device, data]) => 
              `- **${data.name}:** ${data.summary.passRate}% pass rate`
            ).join('\n')}
            
            ### Categories
            ${Object.entries(summary.categories).map(([category, data]) => 
              `- **${category}:** ${data.passRate}% pass rate`
            ).join('\n')}
            
            ${summary.issues.length > 0 ? `
            ### âš ï¸ Issues Found
            ${summary.issues.slice(0, 5).map(issue => 
              `- **${issue.severity.toUpperCase()}:** ${issue.issue} (${issue.device})`
            ).join('\n')}
            ${summary.issues.length > 5 ? `\n... and ${summary.issues.length - 5} more issues` : ''}
            ` : '### ðŸŽ‰ No Issues Found!'}
            
            [View Full Report](https://your-username.github.io/geo-bubble-whispers/test-reports/)
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  notify-results:
    runs-on: ubuntu-latest
    needs: [ios-tests, ios-integration-tests, publish-test-results]
    if: always()
    
    steps:
    - name: Notify Slack on failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#ios-testing'
        text: 'ðŸš¨ iOS testing suite failed! Check the GitHub Actions logs for details.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Notify Slack on success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#ios-testing'
        text: 'âœ… iOS testing suite completed successfully!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}