name: Events System Testing

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/utils/cityDetection.ts'
      - 'src/services/enhancedEventService.ts'
      - 'src/config/ticketmasterMarkets.ts'
      - 'supabase/functions/fetch-events/**'
      - 'supabase/functions/fetch-events-realtime/**'
      - 'tests/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/utils/cityDetection.ts'
      - 'src/services/enhancedEventService.ts'
      - 'src/config/ticketmasterMarkets.ts'
      - 'supabase/functions/fetch-events/**'
      - 'supabase/functions/fetch-events-realtime/**'
      - 'tests/**'
  schedule:
    # Run comprehensive tests daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test scope to run'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - e2e
        - performance
        - regression

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests - City Detection & Event Service
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm run test -- --reporter=verbose
      env:
        CI: true

    - name: Generate test report
      run: npm run test:coverage
      if: always()

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: always()
      with:
        files: ./coverage/lcov.info
        flags: unit-tests
        name: codecov-unit-tests

  geographic-coverage-tests:
    runs-on: ubuntu-latest
    name: Geographic Coverage Tests
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run geographic coverage tests
      run: npm run test -- tests/geographic/ --reporter=verbose
      env:
        CI: true

    - name: Generate coverage report
      run: |
        echo "## Geographic Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "Tests verify city detection for all major US metropolitan areas" >> $GITHUB_STEP_SUMMARY

  api-integration-tests:
    runs-on: ubuntu-latest
    name: API Integration Tests
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run API integration tests
      run: npm run test -- tests/integration/ --reporter=verbose
      env:
        CI: true
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

    - name: Test API endpoints health
      run: |
        echo "Testing API endpoint availability..."
        curl -f https://app.ticketmaster.com/discovery/v2/events.json?apikey=test || echo "Ticketmaster API check skipped (expected in CI)"

  e2e-tests:
    runs-on: ubuntu-latest
    name: End-to-End Tests
    needs: [unit-tests, api-integration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Build application
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

    - name: Run E2E tests
      run: npm run test:e2e
      env:
        CI: true

    - name: Upload E2E test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  performance-tests:
    runs-on: ubuntu-latest
    name: Performance Tests
    needs: unit-tests
    if: github.event_name == 'schedule' || github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'performance'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run performance benchmarks
      run: npm run test:events
      env:
        CI: true
        PERFORMANCE_TEST: true

    - name: Performance regression check
      run: |
        echo "## Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "City detection average time should be < 10ms" >> $GITHUB_STEP_SUMMARY
        echo "API response time should be < 2000ms" >> $GITHUB_STEP_SUMMARY

  regression-tests:
    runs-on: ubuntu-latest
    name: Regression Tests
    needs: [unit-tests, api-integration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run regression tests
      run: npm run test -- tests/regression/ --reporter=verbose
      env:
        CI: true

    - name: Backward compatibility check
      run: |
        echo "## Backward Compatibility" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Legacy LA/NYC/Chicago detection maintained" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Original API signatures preserved" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Database schema compatibility maintained" >> $GITHUB_STEP_SUMMARY

  mobile-e2e-tests:
    runs-on: ubuntu-latest
    name: Mobile E2E Tests
    needs: e2e-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Build application
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

    - name: Run mobile E2E tests
      run: npx playwright test --project="Mobile Chrome" --project="Mobile Safari"
      env:
        CI: true

    - name: Upload mobile test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-test-results
        path: playwright-report/
        retention-days: 7

  comprehensive-report:
    runs-on: ubuntu-latest
    name: Generate Comprehensive Test Report
    needs: [unit-tests, geographic-coverage-tests, api-integration-tests, e2e-tests, regression-tests]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate comprehensive report
      run: |
        echo "# üéØ Ticketmaster Events System Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Geographic Coverage | ${{ needs.geographic-coverage-tests.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| API Integration | ${{ needs.api-integration-tests.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| End-to-End | ${{ needs.e2e-tests.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Regression | ${{ needs.regression-tests.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Coverage Areas Tested" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- üèôÔ∏è **City Detection**: All major US metropolitan areas" >> $GITHUB_STEP_SUMMARY
        echo "- üé´ **Ticketmaster API**: Market-based and geographic searches" >> $GITHUB_STEP_SUMMARY
        echo "- üåç **Geographic Coverage**: 50 states + major cities" >> $GITHUB_STEP_SUMMARY
        echo "- ‚ö° **Performance**: Response times and memory usage" >> $GITHUB_STEP_SUMMARY
        echo "- üîÑ **Integration**: Supabase functions and real-time events" >> $GITHUB_STEP_SUMMARY
        echo "- üì± **Cross-platform**: Desktop and mobile browsers" >> $GITHUB_STEP_SUMMARY
        echo "- üõ°Ô∏è **Error Handling**: Network failures and edge cases" >> $GITHUB_STEP_SUMMARY
        echo "- üîí **Backward Compatibility**: Legacy functionality preserved" >> $GITHUB_STEP_SUMMARY

    - name: Check overall test health
      run: |
        overall_status="success"
        if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then overall_status="failure"; fi
        if [[ "${{ needs.geographic-coverage-tests.result }}" != "success" ]]; then overall_status="failure"; fi
        if [[ "${{ needs.api-integration-tests.result }}" != "success" ]]; then overall_status="failure"; fi
        if [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then overall_status="failure"; fi
        if [[ "${{ needs.regression-tests.result }}" != "success" ]]; then overall_status="failure"; fi
        
        if [[ "$overall_status" == "success" ]]; then
          echo "üéâ All tests passed! Events system is healthy." >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "‚ùå Some tests failed. Please review the results above." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

  security-tests:
    runs-on: ubuntu-latest
    name: Security Tests
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[security]')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=moderate

    - name: Check for hardcoded API keys
      run: |
        echo "Checking for hardcoded secrets..."
        if grep -r "apikey.*=" src/ --include="*.ts" --include="*.tsx" | grep -v "test" | grep -v "mock"; then
          echo "‚ùå Potential hardcoded API keys found"
          exit 1
        else
          echo "‚úÖ No hardcoded API keys detected"
        fi

    - name: Validate environment variable usage
      run: |
        echo "Checking environment variable usage..."
        if grep -r "process.env" src/ --include="*.ts" --include="*.tsx"; then
          echo "‚ö†Ô∏è Direct process.env usage found - consider using Vite env vars"
        fi
        echo "‚úÖ Environment variable check complete"