import{r as p}from"./vendor-C9QPK5wj.js";import{u as A,b,c as _}from"./query-BAKOfRYG.js";import{u as S,s as a}from"./index-Cak4IDZW.js";const I=()=>{const{user:e}=S(),i=A(),{data:h=[],isLoading:f}=b({queryKey:["conversations",e?.id],queryFn:async()=>{if(!e)return[];const{data:s,error:n}=await a.from("conversation_list").select("*").order("last_message_at",{ascending:!1});if(n)throw n;return s},enabled:!!e}),r=s=>b({queryKey:["conversation-messages",s],queryFn:async()=>{const{data:n,error:t}=await a.from("direct_messages").select(`
            *,
            sender:profiles!direct_messages_sender_id_fkey(id, name, avatar_url, username),
            reply_to:direct_messages!direct_messages_reply_to_id_fkey(
              id, content, media_type,
              sender:profiles!direct_messages_sender_id_fkey(name)
            ),
            reactions:message_reactions(
              id, reaction, created_at,
              user:profiles!message_reactions_user_id_fkey(name, avatar_url)
            ),
            status:message_status(id, user_id, status, created_at)
          `).eq("conversation_id",s).eq("is_deleted",!1).order("created_at",{ascending:!0});if(t)throw t;return n},enabled:!!s&&!!e}),l=_({mutationFn:async({conversationId:s,content:n,mediaUrl:t,mediaType:o,replyToId:Q,lat:E,lng:K,voiceDuration:C})=>{if(!e)throw new Error("User not authenticated");const{data:F,error:q}=await a.from("direct_messages").insert({conversation_id:s,sender_id:e.id,content:n,media_url:t,media_type:o,reply_to_id:Q,lat:E,lng:K,voice_duration:C}).select(`
          *,
          sender:profiles!direct_messages_sender_id_fkey(id, name, avatar_url, username)
        `).single();if(q)throw q;return F},onSuccess:s=>{i.invalidateQueries({queryKey:["conversation-messages",s.conversation_id]}),i.invalidateQueries({queryKey:["conversations",e?.id]})}}),m=_({mutationFn:async s=>{if(!e)throw new Error("User not authenticated");const{data:n,error:t}=await a.rpc("get_or_create_conversation",{user1_id:e.id,user2_id:s});if(t)throw t;return n},onSuccess:()=>{i.invalidateQueries({queryKey:["conversations",e?.id]})}}),g=_({mutationFn:async s=>{if(!e)throw new Error("User not authenticated");const n=s.map(o=>({message_id:o,user_id:e.id,status:"read"})),{error:t}=await a.from("message_status").upsert(n,{onConflict:"message_id,user_id"});if(t)throw t},onSuccess:()=>{i.invalidateQueries({queryKey:["conversations",e?.id]})}}),y=_({mutationFn:async({messageId:s,reaction:n})=>{if(!e)throw new Error("User not authenticated");const{data:t,error:o}=await a.from("message_reactions").upsert({message_id:s,user_id:e.id,reaction:n},{onConflict:"message_id,user_id,reaction"}).select();if(o)throw o;return t},onSuccess:(s,n)=>{i.invalidateQueries({queryKey:["conversation-messages"]})}}),w=_({mutationFn:async({messageId:s,reaction:n})=>{if(!e)throw new Error("User not authenticated");const{error:t}=await a.from("message_reactions").delete().eq("message_id",s).eq("user_id",e.id).eq("reaction",n);if(t)throw t},onSuccess:()=>{i.invalidateQueries({queryKey:["conversation-messages"]})}}),u=_({mutationFn:async({messageId:s,content:n})=>{const{data:t,error:o}=await a.from("direct_messages").update({content:n,edited_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",s).select().single();if(o)throw o;return t},onSuccess:s=>{i.invalidateQueries({queryKey:["conversation-messages",s.conversation_id]})}}),c=_({mutationFn:async s=>{const{data:n,error:t}=await a.from("direct_messages").update({is_deleted:!0,deleted_at:new Date().toISOString(),content:null,media_url:null}).eq("id",s).select().single();if(t)throw t;return n},onSuccess:s=>{i.invalidateQueries({queryKey:["conversation-messages",s.conversation_id]})}}),d=p.useCallback(async(s,n)=>{if(!e)return;const{error:t}=await a.from("user_presence").upsert({user_id:e.id,is_online:s,last_seen:new Date().toISOString(),is_typing_in_conversation:n,updated_at:new Date().toISOString()});t&&console.error("Error updating presence:",t)},[e]),{data:v}=b({queryKey:["user-presence",e?.id],queryFn:async()=>{if(!e)return{};const{data:s,error:n}=await a.from("user_presence").select("*");if(n)throw n;return s.reduce((t,o)=>(t[o.user_id]=o,t),{})},enabled:!!e});return{conversations:h,conversationsLoading:f,useConversationMessages:r,sendMessage:l,createOrGetConversation:m,markAsRead:g,addReaction:y,removeReaction:w,editMessage:u,deleteMessage:c,updatePresence:d,userPresence:v||{}}},k=()=>{const{user:e}=S(),i=A();p.useEffect(()=>{if(!e)return;const r=[],l=a.channel("direct_messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"direct_messages"},u=>{const c=u.new;i.setQueryData(["conversation-messages",c.conversation_id],d=>d?[...d,c]:[c]),i.invalidateQueries({queryKey:["conversations",e.id]}),c.sender_id!==e.id&&f()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"direct_messages"},u=>{const c=u.new;i.setQueryData(["conversation-messages",c.conversation_id],d=>d?d.map(v=>v.id===c.id?{...v,...c}:v):[c])}).subscribe();r.push(l);const m=a.channel("conversations").on("postgres_changes",{event:"*",schema:"public",table:"conversations",filter:`participant_1_id=eq.${e.id},participant_2_id=eq.${e.id}`},()=>{i.invalidateQueries({queryKey:["conversations",e.id]})}).subscribe();r.push(m);const g=a.channel("message_reactions").on("postgres_changes",{event:"*",schema:"public",table:"message_reactions"},u=>{i.invalidateQueries({queryKey:["conversation-messages"]})}).subscribe();r.push(g);const y=a.channel("message_status").on("postgres_changes",{event:"*",schema:"public",table:"message_status"},()=>{i.invalidateQueries({queryKey:["conversation-messages"]}),i.invalidateQueries({queryKey:["conversations",e.id]})}).subscribe();r.push(y);const w=a.channel("user_presence").on("postgres_changes",{event:"*",schema:"public",table:"user_presence"},()=>{i.invalidateQueries({queryKey:["user-presence",e.id]})}).subscribe();return r.push(w),()=>{r.forEach(u=>{a.removeChannel(u)})}},[e,i]),p.useEffect(()=>{if(!e)return;const r=async y=>{await a.from("user_presence").upsert({user_id:e.id,is_online:y,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()})};r(!0);const l=()=>{r(!1)},m=()=>{r(!document.hidden)},g=setInterval(()=>{document.hidden||r(!0)},3e4);return window.addEventListener("beforeunload",l),document.addEventListener("visibilitychange",m),()=>{clearInterval(g),window.removeEventListener("beforeunload",l),document.removeEventListener("visibilitychange",m),r(!1)}},[e]);const h=p.useCallback(async r=>{e&&await a.from("user_presence").upsert({user_id:e.id,is_typing_in_conversation:r,updated_at:new Date().toISOString()})},[e]),f=p.useCallback(()=>{try{const r=new Audio;r.src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMcBzuZ4/LNeSsFJHfB8dyKNwkZa7Xo6qBOEwlUp+PyQBkKE2Wz7Oh9JwcheMhy",r.volume=.3,r.play().catch(()=>{})}catch{}},[]);return{setTypingIndicator:h,playMessageSound:f}};export{k as a,I as u};
