import{j as e}from"./ui-DPaiNdCo.js";import{r as v}from"./vendor-Erj86lFQ.js";import{C as P,a as R,d as O,e as F}from"./card-dL58-B1z.js";import{B as S,u as E,t as w,s as _}from"./index--9NxnRVI.js";import{A as y,a as D,b as M}from"./avatar-mWBahg0l.js";import{B as z}from"./badge-Cp48qLeW.js";import{b as Y,X as H,az as q,v as B,a8 as T,e as W,a9 as U,an as J}from"./icons-KaFMl-Yu.js";import{S as G}from"./scroll-area-D1-s-naE.js";import{T as K}from"./textarea-22JmvlCb.js";const X=(t,r,l)=>{if(l)return"event";if(r)return"livestream";if(!t)return"text";const a=t.toLowerCase();return a.includes("rtmp://")||a.includes("webrtc")||a.includes("/live/")||a.includes("livestream")||a.includes("live-stream")?"livestream":a.includes(".mp4")||a.includes(".webm")||a.includes(".mov")||a.includes(".avi")||a.includes(".mkv")||a.includes("video")||a.includes(".m4v")||a.includes(".3gp")?"video":(a.includes(".jpg")||a.includes(".jpeg")||a.includes(".png")||a.includes(".gif")||a.includes(".webp")||a.includes(".svg")||a.includes("image")||a.includes("placeholder.svg"),"image")},he=t=>{switch(t){case"text":return"#DC2626";case"image":return"#16A34A";case"video":return"#9333EA";case"livestream":return"#0EA5E9";case"event":return"#EAB308";default:return"#0EA5E9"}},V=({user:t,location:r,isPublic:l,onClose:a})=>e.jsxs("div",{className:"p-4 pb-2 flex flex-row items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(y,{className:"h-12 w-12 border-2 border-white shadow-md",children:[e.jsx(D,{src:t.avatar,alt:t.name,className:"object-cover"}),e.jsx(M,{className:"bg-gradient-to-br from-purple-500 to-blue-500 text-white text-lg",children:t.name.charAt(0)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-base",children:t.name}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(Y,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:r})]})]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx(z,{variant:l?"default":"secondary",children:l?"Public":"Followers"}),e.jsx(S,{variant:"ghost",size:"icon",onClick:a,className:"h-7 w-7 -mr-2",children:e.jsx(H,{className:"h-4 w-4"})})]})]}),Z=({content:t,mediaUrl:r,timestamp:l,expiresAt:a})=>{const[h,m]=v.useState(!1),u=n=>new Date(n).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),x=n=>{const b=new Date,k=new Date(n).getTime()-b.getTime(),i=Math.floor(k/(1e3*60*60)),c=Math.floor(k%(1e3*60*60)/(1e3*60));return`${i}h ${c}m`},f=X(r,!1);return e.jsxs("div",{className:"p-4 overflow-auto flex-grow",children:[e.jsx("p",{className:"mb-3 text-base",children:t}),r&&e.jsx("div",{className:"w-full rounded-md overflow-hidden h-56 bg-gray-100 mb-3",children:f==="video"?e.jsx("video",{src:r,controls:!0,className:"w-full h-full object-cover",preload:"metadata",children:"Your browser does not support the video tag."}):h?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-200",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(q,{className:"h-8 w-8 mx-auto mb-2"}),e.jsx("p",{className:"text-sm",children:"Image unavailable"})]})}):e.jsx("img",{src:r,alt:"Message media",className:"w-full h-full object-cover",onError:n=>{console.error("Failed to load image:",r),m(!0)},onLoad:()=>{console.log("âœ… Image loaded successfully:",r?.substring(0,50)+"...")}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground mt-2",children:[e.jsxs("span",{children:["Posted ",u(l)]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(B,{className:"h-3 w-3 mr-1"}),e.jsxs("span",{children:[x(a)," left"]})]})]})]})},A=({initialLiked:t=!1,initialLikes:r=0,messageId:l,userName:a,content:h})=>{const[m,u]=v.useState(t),[x,f]=v.useState(r),[n,b]=v.useState(!1),{user:j}=E();return{liked:m,likes:x,showCommentInput:n,handleLike:async d=>{if(d&&d.stopPropagation(),!j){w({title:"Authentication required",description:"Please sign in to like posts",variant:"destructive"});return}try{if(m){const{error:o}=await _.from("likes").delete().eq("user_id",j.id).eq("message_id",l);if(o)throw o;u(!1),f(g=>Math.max(0,g-1))}else{const{error:o}=await _.from("likes").insert({user_id:j.id,message_id:l});if(o)throw o;u(!0),f(g=>g+1),w({title:"Post liked",description:"You've liked this Lo"})}}catch(o){console.error("Error managing like:",o),w({title:"Error",description:o.message||"Failed to update like status",variant:"destructive"})}},handleComment:d=>{if(d&&d.stopPropagation(),!j&&!n){w({title:"Authentication required",description:"Please sign in to comment",variant:"destructive"});return}b(!n),n||w({title:"Comment",description:"Opening comments section"})},handleShare:d=>{d&&d.stopPropagation(),navigator.share?navigator.share({title:`Lo from ${a}`,text:h,url:window.location.href}).catch(o=>{w({title:"Shared",description:"Link copied to clipboard"})}):(navigator.clipboard.writeText(`${window.location.origin}/home?message=${l}`),w({title:"Shared",description:"Link copied to clipboard"}))}}},Q=({liked:t,likes:r,onLike:l,onComment:a,messageId:h,userName:m,messageContent:u})=>{const{handleShare:x}=A({initialLiked:t,initialLikes:r,messageId:h,userName:m,content:u});return e.jsxs("div",{className:"flex justify-between w-full border-t border-b py-2",children:[e.jsxs(S,{variant:"ghost",size:"sm",className:`flex-1 ${t?"text-red-500":""}`,onClick:l,children:[e.jsx(T,{className:`h-4 w-4 mr-1 ${t?"fill-current":""}`}),r>0&&e.jsx("span",{children:r})]}),e.jsxs(S,{variant:"ghost",size:"sm",className:"flex-1",onClick:a,children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),"Comment"]}),e.jsxs(S,{variant:"ghost",size:"sm",className:"flex-1",onClick:x,children:[e.jsx(U,{className:"h-4 w-4 mr-1"}),"Share"]})]})},$=({comment:t,isLiked:r,onLike:l,formatRelativeTime:a})=>e.jsxs("div",{className:"flex items-start group",children:[e.jsxs(y,{className:"h-8 w-8 mr-2",children:[e.jsx(D,{src:t.user.avatar,alt:t.user.name}),e.jsx(M,{className:"text-xs bg-purple-100 text-purple-500",children:t.user.name.charAt(0)})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold mr-2",children:t.user.name}),e.jsx("span",{className:"text-neutral-700",children:t.content})]}),e.jsxs("div",{className:"flex items-center mt-1 text-xs text-neutral-500",children:[e.jsx("span",{className:"mr-3",children:a(t.timestamp)}),t.likes>0&&e.jsxs("span",{className:"mr-3",children:[t.likes," likes"]})]})]}),e.jsx("button",{className:"h-5 w-5 text-neutral-500 hover:text-red-500 group-hover:opacity-100 opacity-0",onClick:l,children:e.jsx(T,{className:`h-3 w-3 ${r?"fill-red-500 text-red-500":""}`})})]}),ee=({comment:t,likedComments:r,replyingTo:l,replyText:a,handleLike:h,handleReplyClick:m,handleSubmitReply:u,setReplyText:x,formatRelativeTime:f})=>e.jsxs("div",{className:"mb-4",children:[e.jsx($,{comment:t,isLiked:!!r[t.id],onLike:()=>h(t.id,t.likes),formatRelativeTime:f}),e.jsx("div",{className:"flex items-center mt-1 text-xs text-neutral-500 ml-10",children:e.jsx("button",{className:"text-xs font-medium mr-3 hover:text-neutral-800",onClick:()=>m(t.id),children:"Reply"})}),l===t.id&&e.jsxs("div",{className:"flex items-center mt-2 ml-10",children:[e.jsx("input",{type:"text",className:"flex-1 text-xs border border-gray-300 rounded-full px-3 py-1.5",placeholder:`Reply to ${t.user.name}...`,value:a,onChange:n=>x(n.target.value),onKeyPress:n=>{n.key==="Enter"&&u(t.id)}}),e.jsx("button",{className:"ml-2 text-xs font-medium text-blue-500 hover:text-blue-700",onClick:()=>u(t.id),children:"Post"})]}),t.replies&&t.replies.length>0&&e.jsx("div",{className:"ml-6 mt-2",children:t.replies.map(n=>e.jsx("div",{className:"flex items-start mb-2 group",children:e.jsx($,{comment:n,isLiked:!!r[n.id],onLike:()=>h(n.id,n.likes),formatRelativeTime:f})},n.id))})]}),te=({comments:t})=>{const[r,l]=v.useState({}),[a,h]=v.useState(null),[m,u]=v.useState(""),[x,f]=v.useState(t),n=i=>{const c=new Date,d=new Date(i),o=c.getTime()-d.getTime(),g=Math.floor(o/(1e3*60)),N=Math.floor(g/60),C=Math.floor(N/24);return C>0?`${C}d`:N>0?`${N}h`:g>0?`${g}m`:"now"},b=(i,c)=>{const d=r[i]||!1,o={...r,[i]:!d};l(o);const g=C=>C.map(p=>p.id===i?{...p,likes:d?c-1:c+1}:p.replies&&p.replies.length>0?{...p,replies:g(p.replies)}:p),N=g(x);f(N),d||w({title:"Comment liked",description:"You've liked this comment"})},j=i=>{h(a===i?null:i),u("")},k=i=>{if(m.trim()==="")return;const c={id:`reply-${Date.now()}`,user:{name:"You",avatar:"https://i.pravatar.cc/150?u=user"},content:m,timestamp:new Date().toISOString(),likes:0},d=x.map(o=>o.id===i?{...o,replies:[...o.replies||[],c]}:o);f(d),h(null),u(""),w({title:"Reply posted",description:"Your reply has been added"})};return e.jsx("div",{className:"space-y-1",children:x.map(i=>e.jsx(ee,{comment:i,likedComments:r,replyingTo:a,replyText:m,handleLike:b,handleReplyClick:j,handleSubmitReply:k,setReplyText:u,formatRelativeTime:n},i.id))})},se=({comment:t,setComment:r,onSubmit:l})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(y,{className:"h-8 w-8",children:[e.jsx(D,{src:"https://i.pravatar.cc/150?u=user",alt:"You"}),e.jsx(M,{className:"text-xs bg-purple-100 text-purple-500",children:"Y"})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(K,{placeholder:"Add a comment...",value:t,onChange:a=>r(a.target.value),className:"w-full resize-none py-2 min-h-0 h-10",rows:1}),t.trim()&&e.jsx(S,{size:"sm",variant:"ghost",className:"absolute right-2 top-1 p-1 h-8 w-8",onClick:l,children:e.jsx(J,{className:"h-4 w-4 text-primary"})})]})]}),ae=({comments:t,comment:r,setComment:l,onSubmitComment:a,showCommentInput:h})=>{const m=t.length>0;return e.jsxs("div",{className:"p-4 pt-0",children:[m&&e.jsx("div",{className:"mt-4 border-t pt-3",children:e.jsx(G,{className:"max-h-[320px]",children:e.jsx("div",{className:"pr-4",children:e.jsx(te,{comments:t})})})}),h&&e.jsx("div",{className:"w-full space-y-2 mt-3",children:e.jsx(se,{comment:r,setComment:l,onSubmit:a})})]})},ie=[{id:"1",user:{name:"Alex Johnson",avatar:"https://i.pravatar.cc/150?u=alex"},content:"This is such a beautiful place! ğŸ˜",timestamp:new Date(Date.now()-36e5*2).toISOString(),likes:5,replies:[{id:"1-reply-1",user:{name:"Sam Williams",avatar:"https://i.pravatar.cc/150?u=sam"},content:"I agree! The lighting is perfect.",timestamp:new Date(Date.now()-36e5*1).toISOString(),likes:2}]},{id:"2",user:{name:"Sam Williams",avatar:"https://i.pravatar.cc/150?u=sam"},content:"I was there last week! The atmosphere is amazing.",timestamp:new Date(Date.now()-36e5*5).toISOString(),likes:2,replies:[]},{id:"3",user:{name:"Taylor Chen",avatar:"https://i.pravatar.cc/150?u=taylor"},content:"Great shot! ğŸ“¸ What camera did you use?",timestamp:new Date(Date.now()-36e5*12).toISOString(),likes:0,replies:[]}],xe=({message:t,onClose:r})=>{const{liked:l,likes:a,showCommentInput:h,handleLike:m,handleComment:u}=A({messageId:t.id,userName:t.user.name,content:t.content}),[x,f]=v.useState(""),[n,b]=v.useState(ie),j=()=>{w({title:"Duration Extended",description:"Message will be available for another 24 hours."})},k=()=>{if(x.trim()){const i={id:`comment-${Date.now()}`,user:{name:"You",avatar:"https://i.pravatar.cc/150?u=user"},content:x.trim(),timestamp:new Date().toISOString(),likes:0,replies:[]};b([i,...n]),f(""),w({title:"Comment posted",description:"Your comment has been added"})}};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:e.jsxs(P,{className:"w-full max-w-md mx-auto bg-white fade-in flex flex-col max-h-[90vh]",children:[e.jsx(R,{className:"p-0",children:e.jsx(V,{user:t.user,location:t.location,isPublic:t.isPublic,onClose:r})}),e.jsxs(O,{className:"p-0 overflow-auto flex-grow",children:[e.jsx(Z,{content:t.content,mediaUrl:t.mediaUrl,timestamp:t.timestamp,expiresAt:t.expiresAt}),e.jsx(ae,{comments:n,comment:x,setComment:f,onSubmitComment:k,showCommentInput:h})]}),e.jsxs(F,{className:"p-4 pt-0 flex-col gap-4",children:[e.jsx(Q,{liked:l,likes:a,onLike:m,onComment:u,messageId:t.id,userName:t.user.name,messageContent:t.content}),e.jsx(S,{onClick:j,variant:"outline",className:"w-full",children:"Extend for 24 More Hours"})]})]})})},fe=()=>{const[t,r]=v.useState({showPublic:!0,showFollowers:!0}),[l,a]=v.useState([]),[h,m]=v.useState(!0),{user:u}=E(),x=i=>{a(c=>[i,...c])},f=(i,c)=>{a(d=>d.map(o=>o.id===i?{...o,...c}:o))},n=async i=>{try{m(!0);const c=new Date(Date.now()-24*60*60*1e3).toISOString();let d=_.from("messages").select("*").or(`expires_at.gte.${new Date().toISOString()},created_at.gte.${c}`).order("created_at",{ascending:!1});i&&i.trim()&&(d=d.or(`content.ilike.%${i}%,location.ilike.%${i}%`));const{data:o,error:g}=await d;let N=null;try{let p=_.from("events").select("*").gte("start_date",new Date().toISOString()).order("start_date",{ascending:!0});i&&i.trim()&&(p=p.or(`title.ilike.%${i}%,description.ilike.%${i}%,venue_name.ilike.%${i}%`));const{data:s}=await p;N=s}catch{}if(g)throw g;let C=[];if(o){const p=o.map(s=>{const L=s.message_type==="event"||s.content?.includes("ğŸ«")||s.content?.includes("#Events")||s.content?.includes("ğŸ“…")&&s.content?.includes("ğŸ“");return s.message_type==="event"&&s.event_source==="ticketmaster"?{id:s.id,content:s.content,mediaUrl:s.media_url,isPublic:s.is_public,location:s.location,timestamp:s.created_at,expiresAt:s.expires_at,user:{name:"ğŸ« Ticketmaster Events",avatar:"https://s1.ticketm.net/dam/a/66e/b68b8edc-ff0e-43a5-8cb8-a4ad0b56c66e_RETINA_PORTRAIT_3_2.jpg"},position:{x:s.lat,y:s.lng},liked:u?s.likes?.some(I=>I.user_id===u.id):!1,likes:s.likes?.length||0,isEvent:!0,eventData:{title:s.event_title,venue:s.event_venue,url:s.event_url,startDate:s.event_start_date,priceMin:s.event_price_min,priceMax:s.event_price_max,source:s.event_source}}:{id:s.id,content:s.content,mediaUrl:s.media_url,isPublic:s.is_public,location:s.location,timestamp:s.created_at,expiresAt:s.expires_at,user:{name:"Lo User",avatar:"/placeholder.svg"},position:{x:s.lat,y:s.lng},liked:!1,likes:0,isEvent:L}});C.push(...p)}if(N){const p=N.map(s=>({id:`event-${s.id}`,content:`ğŸ« ${s.title}

ğŸ“ ${s.venue_name}${s.venue_address?`
${s.venue_address}`:""}

ğŸ“… ${new Date(s.start_date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit"})}

${s.description?`${s.description.slice(0,200)}${s.description.length>200?"...":""}

`:""}${s.price_min?`ğŸ’° From $${s.price_min}

`:""}ğŸ”— ${s.event_url}

#Events #${s.source==="eventbrite"?"Eventbrite":"Ticketmaster"}`,mediaUrl:s.image_url,isPublic:!0,location:s.venue_address||s.venue_name,timestamp:s.created_at,expiresAt:s.start_date,user:{name:`${s.source==="eventbrite"?"Eventbrite":"Ticketmaster"} Events`,avatar:s.source==="eventbrite"?"https://cdn.evbstatic.com/s3-build/fe/build/images/logos/eb-orange-wordmark-no-text.6f6804bb.svg":"https://s1.ticketm.net/dam/a/66e/b68b8edc-ff0e-43a5-8cb8-a4ad0b56c66e_RETINA_PORTRAIT_3_2.jpg"},position:{x:s.lat,y:s.lng},liked:!1,likes:0,isEvent:!0,eventData:s}));C.push(...p)}C.sort((p,s)=>new Date(s.timestamp).getTime()-new Date(p.timestamp).getTime()),a(C)}catch(c){c?.message&&!c.message.includes("JWT")&&!c.message.includes("auth")&&w({title:"Unable to load messages",description:"Please check your connection and try again.",variant:"destructive"})}finally{m(!1)}},b=i=>{n(i)};v.useEffect(()=>{n();const i=_.channel("public:messages").on("postgres_changes",{event:"*",schema:"public",table:"messages"},()=>{n()}).subscribe(),c=()=>{n()};return window.addEventListener("refreshMessages",c),()=>{_.removeChannel(i),window.removeEventListener("refreshMessages",c)}},[u?.id]);const j=(i,c)=>{r(d=>({...d,[i]:c}))},k=l.filter(i=>i.isPublic&&t.showPublic||!i.isPublic&&t.showFollowers);return{filters:t,filteredMessages:k,messages:l,addMessage:x,updateMessage:f,handleFilterChange:j,searchMessages:b,loading:h,refreshMessages:n}};export{xe as M,X as a,A as b,he as g,fe as u};
